using LinearAlgebra

# =========================================================================
#  1. 核心算法：Levinson-Durbin Step-Down (求反射系数)
# =========================================================================
function poly2lattice(a_coeffs)
    # 归一化 (通常 a[1] 已经是 1)
    an = a_coeffs ./ a_coeffs[1]
    
    # 阶数 N
    N = length(an) - 1
    
    # 初始化反射系数数组 k
    k = zeros(Float64, N)
    
    # 当前阶数的多项式系数 (从 z^0 到 z^-m)
    a_curr = copy(an)
    
    # 递推循环：从高阶 N 降到 1
    for m in N:-1:1
        # 1. 提取反射系数 k_m (即当前多项式的最后一项)
        k[m] = a_curr[end]
        
        # 如果不是最后一轮，则计算下一阶多项式
        if m > 1
            # 2. 计算分母 (1 - k^2)
            denom = 1 - k[m]^2
            
            # 检查稳定性/奇异性
            if abs(denom) < 1e-9
                println("警告: 系统不稳定或临界稳定，|k| >= 1")
            end
            
            # 3. 降阶公式: a'_{i} = (a_i - k * a_{m-i}) / (1 - k^2)
            # 注意: Julia 索引从 1 开始 (a[1] 是 z^0, a[i+1] 是 z^-i)
            a_prev = zeros(Float64, m) # 长度为 m (阶数为 m-1)
            a_prev[1] = 1.0            # 首项始终为 1
            
            for i in 1:(m-1)
                # a_curr[i+1] 对应 z^-i
                # a_curr[m-i+1] 对应 z^{-(m-i)}
                a_prev[i+1] = (a_curr[i+1] - k[m] * a_curr[m - i + 1]) / denom
            end
            
            # 更新当前多项式
            a_curr = a_prev
        end
    end
    
    return k
end

# =========================================================================
#  2. 主程序：解决第 35 题
# =========================================================================

# 题目给定的分母系数 (Denominator Coefficients)
# D(z) = 1 + 3z^-1 - 5z^-2 + 2z^-3 - 4z^-4 + 3z^-5
a_coeffs = [1.0, 3.0, -5.0, 2.0, -4.0, 3.0]

println("正在计算格型结构系数...")
k_coeffs = poly2lattice(a_coeffs)

# =========================================================================
#  3. 结果输出
# =========================================================================
println("\n=======================================================")
println("             第 35 题计算结果")
println("=======================================================")
println("系统分母系数: ", a_coeffs)
println("-------------------------------------------------------")
println("级联格型结构乘法器系数 (反射系数 k):")

for i in 1:length(k_coeffs)
    println("  k[$i] = $(round(k_coeffs[i], digits=4))")
end
println("-------------------------------------------------------")

# 简单验证: 在全通格型结构中，k_N 应该等于 a_N
println("验证: k[5] 是否等于 a[5]? -> ", isapprox(k_coeffs[end], a_coeffs[end]))